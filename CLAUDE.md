# CLAUDE.md

This file provides comprehensive guidance to Claude Code when working with code in this repository.

## Core Development Philosophy

### KISS (Keep It Simple, Stupid)

Simplicity should be a key goal in design. Choose straightforward solutions over complex ones whenever possible. Simple solutions are easier to understand, maintain, and debug.

### YAGNI (You Aren't Gonna Need It)

Avoid building functionality on speculation. Implement features only when they are needed, not when you anticipate they might be useful in the future.

### Design Principles

- **Dependency Inversion**: High-level modules should not depend on low-level modules. Both should depend on abstractions.
- **Open/Closed Principle**: Software entities should be open for extension but closed for modification.
- **Single Responsibility**: Each function, class, and module should have one clear purpose.
- **Fail Fast**: Check for potential errors early and raise exceptions immediately when issues occur.

## ğŸ§± Code Structure & Modularity

### File and Function Limits

- **Never create a file longer than 500 lines of code**. If approaching this limit, refactor by splitting into modules.
- **Functions should be under 50 lines** with a single, clear responsibility.
- **Classes should be under 100 lines** and represent a single concept or entity.
- **Organize code into clearly separated modules**, grouped by feature or responsibility.

### Project Structure

Follow strict vertical slice architecture with tests living next to the code they test:

```
ha-management-mvp/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ api/                          # Node.js API
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â””â”€â”€ app.ts
â”‚   â”‚   â”œâ”€â”€ tests/                    # API-specific tests
â”‚   â”‚   â”‚   â”œâ”€â”€ unit/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ middleware/
â”‚   â”‚   â”‚   â”œâ”€â”€ integration/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ auth.test.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ fixtures/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ testData.ts
â”‚   â”‚   â”‚   â””â”€â”€ setup/
â”‚   â”‚   â”‚       â”œâ”€â”€ testDb.ts
â”‚   â”‚   â”‚       â””â”€â”€ globalSetup.ts
â”‚   â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â””â”€â”€ web/                          # Next.js Frontend
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ pages/
â”‚       â”‚   â”œâ”€â”€ components/
â”‚       â”‚   â”œâ”€â”€ lib/
â”‚       â”‚   â””â”€â”€ styles/
â”‚       â”œâ”€â”€ __tests__/                # Frontend tests
â”‚       â”‚   â”œâ”€â”€ components/
â”‚       â”‚   â”œâ”€â”€ pages/
â”‚       â”‚   â”œâ”€â”€ lib/
â”‚       â”‚   â””â”€â”€ __mocks__/
â”‚       â””â”€â”€ package.json
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ database/                     # Prisma schema and migrations
â”‚   â”‚   â”œâ”€â”€ prisma/
â”‚   â”‚   â”œâ”€â”€ tests/                    # Database/migration tests
â”‚   â”‚   â”‚   â”œâ”€â”€ migrations/
â”‚   â”‚   â”‚   â””â”€â”€ seed.test.ts
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â””â”€â”€ shared/                       # Shared TypeScript types
â”‚       â”œâ”€â”€ src/
â”‚       â”œâ”€â”€ tests/                    # Shared utility tests
â”‚       â””â”€â”€ package.json
â”œâ”€â”€ tests/                            # E2E and integration tests
â”‚   â”œâ”€â”€ e2e/
â”‚   â”‚   â”œâ”€â”€ auth.spec.ts
â”‚   â”‚   â”œâ”€â”€ ha-management.spec.ts
â”‚   â”‚   â””â”€â”€ documents.spec.ts
â”‚   â”œâ”€â”€ fixtures/
â”‚   â”‚   â”œâ”€â”€ users.json
â”‚   â”‚   â””â”€â”€ ha-data.json
â”‚   â””â”€â”€ playwright.config.ts
â”œâ”€â”€ infrastructure/
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â”œâ”€â”€ test.yml                  # Test workflow
â”‚       â”œâ”€â”€ build.yml
â”‚       â””â”€â”€ deploy.yml
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ docker-compose.test.yml           # Test environment
â””â”€â”€ README.md
```

## ğŸ› ï¸ Development Environment

## ğŸ“‹ Style & Conventions

### Code Style Guidelines

#### Frontend Style Guide (Next.js/React)
- **Primary**: [Airbnb JavaScript/React Style Guide](https://github.com/airbnb/javascript)
- **TypeScript**: [Airbnb TypeScript Config](https://github.com/airbnb/javascript/tree/master/packages/eslint-config-airbnb-typescript)
- **Component Naming**: PascalCase for components, camelCase for utilities
- **File Naming**: kebab-case for pages, PascalCase for components
- **Import Order**: External libraries â†’ Internal modules â†’ Relative imports

#### Backend Style Guide (Node.js/Express)
- **Primary**: [Google TypeScript Style Guide](https://google.github.io/styleguide/tsguide.html)
- **Function Documentation**: TSDoc comments for public APIs
- **Error Handling**: Explicit error types, no `any` types
- **File Naming**: kebab-case for all files
- **Import Order**: Node modules â†’ Local modules â†’ Types

#### Database Style Guide (Prisma)
- **Model Naming**: PascalCase for models
- **Field Naming**: camelCase for fields
- **Enum Naming**: SCREAMING_SNAKE_CASE for enum values
- **Relation Naming**: Descriptive names (e.g., `authoredPosts`, not `posts`)

#### General TypeScript Rules
- **Strict Mode**: All TypeScript strict flags enabled
- **No `any`**: Explicit types required
- **Return Types**: Required for all public functions
- **Interface vs Type**: Interfaces for object shapes, types for unions

### Code Quality Tools

#### Linting & Formatting
```json
{
  "devDependencies": {
    "@typescript-eslint/eslint-plugin": "^6.0.0",
    "@typescript-eslint/parser": "^6.0.0",
    "eslint-config-airbnb": "^19.0.4",
    "eslint-config-airbnb-typescript": "^17.1.0",
    "eslint-config-google": "^0.14.0",
    "eslint-config-prettier": "^9.0.0",
    "prettier": "^3.0.0",
    "husky": "^8.0.3",
    "lint-staged": "^14.0.1"
  }
}
```

#### Pre-commit Hooks (`.husky/pre-commit`)
```bash
#!/usr/bin/env sh
npx lint-staged
npm run test:unit
```

#### Lint-staged Configuration (`package.json`)
```json
{
  "lint-staged": {
    "apps/web/**/*.{ts,tsx}": [
      "eslint --fix",
      "prettier --write"
    ],
    "apps/api/**/*.{ts}": [
      "eslint --fix",
      "prettier --write"
    ],
    "**/*.{json,md}": [
      "prettier --write"
    ]
  }
}
```

## ğŸ§ª Testing Strategy

### Test-Driven Development (TDD)

1. **Write the test first** - Define expected behavior before implementation
2. **Watch it fail** - Ensure the test actually tests something
3. **Write minimal code** - Just enough to make the test pass
4. **Refactor** - Improve code while keeping tests green
5. **Repeat** - One test at a time

### Testing Best Practices

### Test Organization

- Unit tests: Test individual functions/methods in isolation
- Integration tests: Test component interactions
- End-to-end tests: Test complete user workflows
- Keep test files next to the code they test
- Aim for 80%+ code coverage, but focus on critical paths

## ğŸš¨ Error Handling

### Exception Best Practices

### Logging Strategy

## ğŸ”§ Configuration Management

### Environment Variables and Settings

## ğŸ—ï¸ Data Models and Validation


## ğŸ”„ Git Workflow

### Branch Strategy

- `main` - Production-ready code
- `develop` - Integration branch for features
- `feature/*` - New features
- `fix/*` - Bug fixes
- `docs/*` - Documentation updates
- `refactor/*` - Code refactoring
- `test/*` - Test additions or fixes

### Commit Message Format

Never include claude code, or written by claude code in commit messages

```
<type>(<scope>): <subject>

<body>

<footer>
``
Types: feat, fix, docs, style, refactor, test, chore

Example:
```

feat(auth): add two-factor authentication

- Implement TOTP generation and validation
- Add QR code generation for authenticator apps
- Update user model with 2FA fields

Closes #123

````

## ğŸ—„ï¸ Database Naming Standards

### Entity-Specific Primary Keys
All database tables use entity-specific primary keys for clarity and consistency:

```sql
-- âœ… STANDARDIZED: Entity-specific primary keys
sessions.session_id UUID PRIMARY KEY
leads.lead_id UUID PRIMARY KEY
messages.message_id UUID PRIMARY KEY
daily_metrics.daily_metric_id UUID PRIMARY KEY
agencies.agency_id UUID PRIMARY KEY
````
### Model-Database Alignment

## ğŸ“ Documentation Standards

### Code Documentation

- Every module should have a docstring explaining its purpose
- Public functions must have complete docstrings
- Complex logic should have inline comments with `# Reason:` prefix
- Keep README.md updated with setup instructions and examples
- Maintain CHANGELOG.md for version history

### API Documentation


## ğŸš€ Performance Considerations

### Optimization Guidelines

- Profile before optimizing - use `cProfile` or `py-spy`
- Use `lru_cache` for expensive computations
- Prefer generators for large datasets
- Use `asyncio` for I/O-bound operations
- Consider `multiprocessing` for CPU-bound tasks
- Cache database queries appropriately

### Example Optimization

## ğŸ›¡ï¸ Security Best Practices

### Security Guidelines

- Never commit secrets - use environment variables
- Validate all user input with Pydantic
- Use parameterized queries for database operations
- Implement rate limiting for APIs
- Use HTTPS for all external communications
- Implement proper authentication and authorization

### Example Security Implementation

## ğŸ” Debugging Tools

### Debugging Commands


## ğŸ“Š Monitoring and Observability

### Structured Logging



## ğŸ“š Useful Resources

### Essential Tools

- UV Documentation: https://github.com/astral-sh/uv
- Ruff: https://github.com/astral-sh/ruff
- Pytest: https://docs.pytest.org/
- Pydantic: https://docs.pydantic.dev/
- FastAPI: https://fastapi.tiangolo.com/


## âš ï¸ Important Notes

- **NEVER ASSUME OR GUESS** - When in doubt, ask for clarification
- **Always verify file paths and module names** before use
- **Keep CLAUDE.md updated** when adding new patterns or dependencies
- **Test your code** - No feature is complete without tests
- **Document your decisions** - Future developers (including yourself) will thank you

## ğŸ” Search Command Requirements

**CRITICAL**: Always use `rg` (ripgrep) instead of traditional `grep` and `find` commands:

```bash
# âŒ Don't use grep
grep -r "pattern" .

# âœ… Use rg instead
rg "pattern"

# âŒ Don't use find with name
find . -name "*.py"

# âœ… Use rg with file filtering
rg --files | rg "\.py$"
# or
rg --files -g "*.py"
```

**Enforcement Rules:**

```
(
    r"^grep\b(?!.*\|)",
    "Use 'rg' (ripgrep) instead of 'grep' for better performance and features",
),
(
    r"^find\s+\S+\s+-name\b",
    "Use 'rg --files | rg pattern' or 'rg --files -g pattern' instead of 'find -name' for better performance",
),
```

## ğŸš€ GitHub Flow Workflow Summary

main (protected) â†â”€â”€ PR â†â”€â”€ feature/your-feature
â†“ â†‘
deploy development

### Daily Workflow:

1. git checkout main && git pull origin main
2. git checkout -b feature/new-feature
3. Make changes + tests
4. git push origin feature/new-feature
5. Create PR â†’ Review â†’ Merge to main

---

_This document is a living guide. Update it as the project evolves and new patterns emerge._